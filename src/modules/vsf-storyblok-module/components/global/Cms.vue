<template>
  <div>
    <slot v-if="loading" name="loading" />
    <slot v-else-if="error" name="error" />
    <slot v-else />
  </div>
</template>

<script>
import config from 'config'
import fetch from 'isomorphic-fetch'
import { processURLAddress } from '@vue-storefront/core/helpers'

import { loadScript } from '../../helpers'
import { resolveParentData } from '../../helpers/resolve-parent-data.function'

export default {
  name: 'StoryblokCms',
  data () {
    return {
      loading: true,
      error: false,
      story: null
    }
  },
  props: {
    uuid: {
      type: String,
      required: true
    }
  },
  methods: {
    updateValue: function (value) {
      this.$emit('input', value.content ? value.content : value)
    },
    async fetchStory () {
      const url = processURLAddress(`${config.storyblok.endpoint}/get-by-uuid?uuid=${this.uuid}`)
      const response = await fetch(url)
      const json = await response.json()
      this.loading = false
      if (json.stories && json.stories[0]) {
        this.updateValue(json.stories[0])
        return json.stories[0]
      } else {
        this.error = true
      }
    }
  },
  async serverPrefetch () {
    return this.fetchStory()
  },
  async mounted () {
    if (!this.story) {
      await this.fetchStory()
    }

    if (this.previewToken) {
      const url = 'https://app.storyblok.com/f/storyblok-v2-latest.js'

      await loadScript(url, 'storyblok-javascript-bridge')

      const StoryblokBridge = window['StoryblokBridge'];

      const storyblokInstance = new StoryblokBridge({
        resolveRelations: ['block_reference.reference', 'page.parent']
      });

      storyblokInstance.on(['input', 'published', 'change'], (event) => {
        if (event.action === 'input') {
          if (event.story?.content?.parent) {
            event.story.content.parent = resolveParentData(event.story.content.parent)
          }

          this.updateValue(event.story)
        }
      })
    }
  }
}
</script>
